# 1.nginx 默认不支持下划线 underscore

昨天遇见一个问题，本地请求好好的，部署到测试环境，就不行了👻

> 程序员通病：我本地好好的，是不是你环境有问题

经过排查，发现 header 中的 AUTH_TOKEN 没有传到后端服务，这个是 nginx 的锅（不是代码问题😂）



## 解决方案

- 1: 改代码，auth-token 是标准写法
- 2: 改配置，在`nginx`里的 `nginx.conf`文件中配置 http 的部分添加`underscores_in_headers on`;（[默认值是](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F61044271) [`off`](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F61044271)，表示如果`header name`中包含下划线，则忽略掉）

敲重点：

> - Nginx 不支持路下划线（_）, 所有无论是**请求路径**、还是在 nginx 中配置的**磁盘路径**中，[都不要用带下划线的路径](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fwww.cnblogs.com%2Fzjfblog%2Fp%2F15101751.html)。



## 为什么

为什么大多数服务器如 Apache 或 Nginx 将下划线定义为非法的，标准没有限制下划线。

[RFC2616](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fwww.w3.org%2FProtocols%2Frfc2616%2Frfc2616-sec4.html) 的 4.2 部分遵循相同的通用格式，在 [RFC822](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fwww.ietf.org%2Frfc%2Frfc822.txt) 的 3.1 部分：

> 字段名称必须由可打印的 ASCII 字符（即 33 和 126 之间的值的字符，小数，除了冒号）
>
> 下划线是 ASCII 表（属于 33-126 范围）95 小数字符。

官方文档：[https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#missing-disappearing-http-headers](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fwww.nginx.com%2Fresources%2Fwiki%2Fstart%2Ftopics%2Ftutorials%2Fconfig_pitfalls%2F%23missing-disappearing-http-headers)

> **Missing (disappearing) HTTP Headers**
>
> If you do not explicitly set `underscores_in_headers on;`, NGINX will silently drop HTTP headers with underscores (which are perfectly valid according to the HTTP standard). This is done in order to prevent ambiguities when mapping headers to CGI variables as both dashes and underscores are mapped to underscores during that process.

就是说，之前 CGI 处理的时候把 下划线 和 中划线 都当成了下划线，历史遗留问题

> 如果未显式设置 underlines_in_headers on；NGINX 将默认删除带有下划线的 HTTP 头（根据 HTTP 标准，这是完全有效的）。这样做是为了防止在将 header 映射到 CGI 变量时出现歧义，因为在该过程中，中划线（破折号）和下划线都映射到了下划线。



## 延伸阅读



### http 请求头 header 要全部小写

- [RFC 2616](https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fmirrors.nju.edu.cn%2Frfc%2Fbeta%2Ferrata%2Frfc2616.html) - "Hypertext Transfer Protocol -- HTTP/1.1"，Section 4.2, "Message Headers"：每个 header 字段由一个名称后跟一个冒号 (":") 和字段值组成。字段名称不区分大小写。

- [RFC 7230](https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7230%23section-3.2)（HTTP/1.1）声明：“每个标头字段由不区分大小写的字段名称后跟冒号 (":")、可选的前导空格、字段值和可选的尾随组成空格。

- RFC 7540

   

  (HTTP/2)：就像在 HTTP/1.x 中一样，标头字段名称是 ASCII 字符串，

  以不区分大小写的方式比较的字符。

  标头字段名称必须在 HTTP/2 中编码之前转换为小写。包含大写标头字段名称的请求或响应必须被视为格式错误（第 8.1.2.6 节）



### http 请求方法区分大小写

Method =

 "OPTIONS" ; Section 9.2

| "GET" ; Section 9.3

| "HEAD" ; Section 9.4

| "POST" ; Section 9.5

| "PUT" ; Section 9.6

| "DELETE" ; Section 9.7

| "TRACE" ; Section 9.8

| "CONNECT" ; Section 9.9

| extension-method

extension-method = token

 

curl -X put 小写，会从服务器返回 400 bad request cryptic 错误。 curl -X PUT 正常。



### Nodejs http/proxy 等

nodejs 中 header 都是小写的形式，所以 http-proxy 等第三方库都就进行了转换，将请求全部 header 转为小写。